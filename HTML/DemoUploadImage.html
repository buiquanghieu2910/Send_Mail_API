<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Image</title>
    <!-- CSS only -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-toast-plugin/1.3.2/jquery.toast.css">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css">
</head>

<body ng-app="app-demo">
    <div class="container" ng-controller="ctrl">
        <!-- Button trigger modal -->
        <div class="row mt-5">
            <div class="col-md-3 border rounded">
                <h4 class="mt-3 text-center">Folder</h4>
                <div>
                    <button class="btn btn-primary mt-3" ng-click="createFolder()">Tạo folder</button>
                </div>
                <p class="mt-3 text-danger text-center fst-italic">Click 2 chuột trái để mở !</p>

                <div class="row">
                    <div class="col-md-4 mb-2" ng-repeat="folder in folders">
                        <button ng-dblclick="clickFolder(folder)" class="btn"> <i style="font-size: 35pt;"
                                class="bi bi-folder-fill"></i><br>{{folder}}</button>
                    </div>
                </div>
            </div>

            <div class="col-md-9 border rounded">
                <h4 class="mt-3 text-center">All file by folder name {{dir}}</h4>
                <button type="button" class="btn btn-success mt-3 mb-3" data-bs-toggle="modal"
                    data-bs-target="#modalUpload">
                    Upload image
                </button>
                <p class="text-danger fst-italic">Click 2 chuột trái để xóa !</p>


                <div style="height: 500px; overflow: auto;">
                    <div class="row">
                        <div ng-if="dir" class="col-md-2 mb-2 rounded border" ng-repeat="name in fileName">
                            <img ng-dblclick="removeImage(name)" class="img-fluid"
                                src="http://localhost:8080/TestSendMail/assets/images/{{dir}}/{{name}}" alt="">

                        </div>
                    </div>
                </div>

                <!-- <div class="row border rounded">
                    <h2 class="text-center mb-3 mt-2">Tài nguyên ảnh</h2>

                    <div>
                        <select class="form-select" aria-label="Default select example" ng-model="folderValue"
                            ng-change="changeFolder()">
                            <option ng-repeat="folder in folders" value="{{folder}}">{{folder}}</option>
                        </select>
                    </div>

                    <div class="row">
                        <p class="text-danger fst-italic mt-2">Click 2 chuột trái để xóa !</p>
                    </div>
                    <div class="row mt-3 mb-3">
                        <div class="col-md-2" ng-repeat="name in fileName">
                            <img ng-dblclick="removeImage(name)" class="img-fluid"
                                src="http://localhost:8080/TestSendMail/assets/images/{{dir}}/{{name}}" alt="">

                        </div>
                    </div>
                </div> -->
            </div>
        </div>


        <!-- Button trigger modal -->
        <!-- <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalUpload">
            Upload image
        </button> -->

        <!-- Modal -->
        <!-- <div class="modal fade" id="modalUpload" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">

                        <div class="row mb-3">
                            <label for="">Folder</label>
                            <select class="form-select" aria-label="Default select example" ng-model="folderUpload">
                                <option ng-repeat="folder in folders" value="{{folder}}">{{folder}}</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="image" class="form-label">UploadImage</label>
                            <input type="file" class="form-control" id="image"
                                onchange="angular.element(this).scope().imageChanged(this.files)">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-success">Save changes</button>
                    </div>
                </div>
            </div>
        </div> -->

        <!-- Button trigger modal -->
        <!-- <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalGet">
            Get Image
        </button> -->

        <!-- Modal -->
        <!-- <div class="modal fade" id="modalGet" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <select class="form-select" aria-label="Default select example" ng-model="folderValue"
                                ng-change="changeFolder()">
                                <option ng-repeat="folder in folders" value="{{folder}}">{{folder}}</option>
                            </select>
                        </div>
                        <div class="row">
                            <p class="text-danger fst-italic">Click 2 chuột trái để xóa !</p>
                        </div>
                        <div class="row mt-3">
                            <div class="col-md-3" ng-repeat="name in fileName">
                                <img ng-dblclick="removeImage(name)" class="img-fluid"
                                    src="http://localhost:8080/TestSendMail/assets/images/{{dir}}/{{name}}" alt="">

                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary">Save changes</button>
                    </div>
                </div>
            </div>
        </div> -->


        <!-- Modal Upload -->
        <div class="modal fade" id="modalUpload" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">

                        <div class="row mb-3">
                            <label for="">Folder</label>
                            <select class="form-select" aria-label="Default select example" ng-model="folderUpload">
                                <option ng-repeat="folder in folders" value="{{folder}}">{{folder}}</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="image" class="form-label">UploadImage</label>
                            <input type="file" class="form-control" id="image"
                                onchange="angular.element(this).scope().imageChanged(this.files)">
                        </div>

                        <div class="mb-3">
                            <label for="image" class="form-label">List file</label>
                            <input type="file" class="form-control" id="image-lst" multiple
                                onchange="angular.element(this).scope().imageLstChanged(this.files)">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <!-- <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Upload</button> -->
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"
        integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- JavaScript Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa"
        crossorigin="anonymous"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.3/angular.min.js"
        integrity="sha512-KZmyTq3PLx9EZl0RHShHQuXtrvdJ+m35tuOiwlcZfs/rE7NZv29ygNA8SFCkMXTnYZQK2OX0Gm2qKGfvWEtRXA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-toast-plugin/1.3.2/jquery.toast.min.js"></script>

    <script>
        const app = angular.module("app-demo", []);

        app.controller('ctrl', function ($scope, $http) {
            //Upload image
            $scope.imageChanged = function (files) {
                var data = new FormData();
                data.append('file', files[0]);
                $scope.isLoading = true;
                $http.post(`http://localhost:8080/TestSendMail/rest/upload/images/${$scope.folderUpload}`, data, {
                    transformRequest: angular.identity,
                    headers: { 'Content-Type': undefined }
                }).then(resp => {
                    $('#modalUpload').modal('hide');
                    toastMessage('Thêm mới thành công !', '', 'success');
                    $scope.changeFolder();
                }).catch(error => {
                    toastMessage('Thêm mới thất bại !', '', 'error');
                    console.log(error);
                })
            }


            $scope.imageLstChanged = async function (multipleFiles) {
                console.log(multipleFiles.length)
                var fd = new FormData();
                console.log(fd);
                for (let index = 0; index < multipleFiles.length; index++) {
                    fd.append('multipleFiles', multipleFiles[index]);
                }
                var data = await new FormData();
                // await console.log(files[0]);
                // for (let index = 0; index < files.length; index++) {
                //     await data.append('file', files[index]);
                // }

                await $http.post(`http://localhost:8080/TestSendMail/upload/multiple/files`, fd, {
                    transformRequest: angular.identity,
                    headers: { 'Content-Type': undefined }
                }).then(resp => {
                    $('#modalUpload').modal('hide');
                    toastMessage('Thêm mới thành công !', '', 'success');
                }).catch(error => {
                    toastMessage('Thêm mới thất bại !', '', 'error');
                    console.log(error);
                })
            }

            $scope.loadFolder = function () {
                $http.get(`http://localhost:8080/TestSendMail/get-all-folder`)
                    .then(resp => {
                        $scope.folders = resp.data;
                        $scope.folderValue = resp.data[0];
                        $scope.folderUpload = resp.data[0];
                        $scope.changeFolder();
                        console.log(resp.data);
                    })
                    .catch(error => {
                        console.log(error);
                    });
            }

            $scope.loadFolder();


            $scope.changeFolder = function () {
                // console.log($scope.folderValue)
                $http.get(`http://localhost:8080/TestSendMail/get-all-file/${$scope.folderValue}`)
                    .then(resp => {
                        $scope.dir = angular.copy($scope.folderValue);
                        $scope.fileName = resp.data;
                        // console.log(resp.data);
                    })
                    .catch(error => {
                        console.log(error);
                    });
            };

            $scope.removeImage = function (fileName) {
                Swal.fire({
                    title: 'Are you sure?',
                    text: "You won't be able to revert this!",
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Yes, delete it!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $scope.apiRemove($scope.folderValue, fileName);
                    }
                })
            };

            $scope.apiRemove = function (folder, fileName) {
                $http.delete(`http://localhost:8080/TestSendMail/delete-file/${folder}/${fileName}`)
                    .then(resp => {
                        Swal.fire(
                            'Deleted!',
                            'Your file name ' + fileName + ' has been deleted.',
                            'success'
                        );
                        $scope.changeFolder();
                    })
                    .catch(error => {
                        console.log(error);
                        Swal.fire(
                            'Failed!',
                            'Your file name ' + fileName + ' has been failed.',
                            'error'
                        );
                    });
            };

            $scope.clickFolder = function (folder) {
                $http.get(`http://localhost:8080/TestSendMail/get-all-file/${folder}`)
                    .then(resp => {
                        $scope.dir = angular.copy(folder);
                        $scope.fileName = resp.data;
                        // console.log(resp.data);
                    })
                    .catch(error => {
                        console.log(error);
                    });
            }

            $scope.createFolder = async function () {
                const { value: folderName } = await Swal.fire({
                    title: 'Input folder name',
                    input: 'text',
                    // inputLabel: 'Folder name',
                    inputPlaceholder: 'Enter folder name'
                })

                if (folderName) {
                    // Swal.fire(`Entered email: ${folderName}`)
                    var folder = await {
                        folderName: folderName
                    }
                    await $http.post(`http://localhost:8080/TestSendMail/create-folder`, folder)
                        .then(resp => {
                            $scope.loadFolder();
                        })
                        .catch(error => {
                            console.log(error);
                        });
                }
            }


            function toastMessage(heading, text, icon) {
                $.toast({
                    heading: heading,
                    text: text,
                    position: 'top-right',
                    icon: icon
                })
            }

        });
    </script>
</body>


</html>